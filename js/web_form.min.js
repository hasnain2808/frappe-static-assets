!function(){"use strict";frappe.provide("frappe.datetime"),frappe.defaultDateFormat="YYYY-MM-DD",frappe.defaultTimeFormat="HH:mm:ss",frappe.defaultDatetimeFormat=frappe.defaultDateFormat+" "+frappe.defaultTimeFormat,moment.defaultFormat=frappe.defaultDateFormat,frappe.provide("frappe.datetime"),$.extend(frappe.datetime,{convert_to_user_tz:function(e,t){if(frappe.sys_defaults.time_zone)var a=moment.tz(e,frappe.sys_defaults.time_zone).local();else a=moment(e);return!1===t?a:a.format(frappe.defaultDatetimeFormat)},convert_to_system_tz:function(e,t){if(frappe.sys_defaults.time_zone)var a=moment(e).tz(frappe.sys_defaults.time_zone);else a=moment(e);return!1===t?a:a.format(frappe.defaultDatetimeFormat)},is_timezone_same:function(){return!frappe.sys_defaults.time_zone||moment().tz(frappe.sys_defaults.time_zone).utcOffset()===moment().utcOffset()},str_to_obj:function(e){return moment(e,frappe.defaultDatetimeFormat)._d},obj_to_str:function(e){return moment(e).locale("en").format()},obj_to_user:function(e){return moment(e).format(frappe.datetime.get_user_date_fmt().toUpperCase())},get_diff:function(e,t){return moment(e).diff(t,"days")},get_hour_diff:function(e,t){return moment(e).diff(t,"hours")},get_day_diff:function(e,t){return moment(e).diff(t,"days")},add_days:function(e,t){return moment(e).add(t,"days").format()},add_months:function(e,t){return moment(e).add(t,"months").format()},week_start:function(){return moment().startOf("week").format()},week_end:function(){return moment().endOf("week").format()},month_start:function(){return moment().startOf("month").format()},month_end:function(){return moment().endOf("month").format()},quarter_start:function(){return moment().startOf("quarter").format()},quarter_end:function(){return moment().endOf("quarter").format()},year_start:function(){return moment().startOf("year").format()},year_end:function(){return moment().endOf("year").format()},get_user_time_fmt:function(){return frappe.sys_defaults&&frappe.sys_defaults.time_format||"HH:mm:ss"},get_user_date_fmt:function(){return frappe.sys_defaults&&frappe.sys_defaults.date_format||"yyyy-mm-dd"},get_user_fmt:function(){return frappe.sys_defaults&&frappe.sys_defaults.date_format||"yyyy-mm-dd"},str_to_user:function(e,t){if(void 0===t&&(t=!1),!e)return"";var a=frappe.datetime.get_user_time_fmt();if(t)return moment(e,frappe.defaultTimeFormat).format(a);var r=frappe.datetime.get_user_date_fmt().toUpperCase();return"string"!=typeof e||-1===e.indexOf(" ")?moment(e).format(r):moment(e,"YYYY-MM-DD HH:mm:ss").format(r+" "+a)},get_datetime_as_string:function(e){return moment(e).format("YYYY-MM-DD HH:mm:ss")},user_to_str:function(e,t){void 0===t&&(t=!1);var a=frappe.datetime.get_user_time_fmt();if(t)return moment(e,a).format(frappe.defaultTimeFormat);var r=frappe.datetime.get_user_date_fmt().toUpperCase(),n="YYYY-MM-DD";return-1!==e.indexOf(" ")&&(r+=" "+a,n+=" HH:mm:ss"),moment(e,[r.replace("YYYY","YY"),r]).locale("en").format(n)},user_to_obj:function(e){return frappe.datetime.str_to_obj(frappe.datetime.user_to_str(e))},global_date_format:function(e){var t=moment(e);return t._f&&-1!==t._f.indexOf("HH")?t.format("Do MMMM YYYY, h:mma"):t.format("Do MMMM YYYY")},now_date:function(e){return void 0===e&&(e=!1),frappe.datetime._date(frappe.defaultDateFormat,e)},now_time:function(e){return void 0===e&&(e=!1),frappe.datetime._date(frappe.defaultTimeFormat,e)},now_datetime:function(e){return void 0===e&&(e=!1),frappe.datetime._date(frappe.defaultDatetimeFormat,e)},_date:function(e,t){void 0===t&&(t=!1);var a,r=frappe.sys_defaults&&frappe.sys_defaults.time_zone;return a=r?moment.tz(r):moment(),t?frappe.datetime.moment_to_date_obj(a):a.format(e)},moment_to_date_obj:function(e){var t=new Date,a=e.toArray();return t.setFullYear(a[0]),t.setMonth(a[1]),t.setDate(a[2]),t.setHours(a[3]),t.setMinutes(a[4]),t.setSeconds(a[5]),t.setMilliseconds(a[6]),t},nowdate:function(){return frappe.datetime.now_date()},get_today:function(){return frappe.datetime.now_date()},get_time:function(e){return moment(e).format("hh:mm A")},validate:function(e){return moment(e,[frappe.defaultDateFormat,frappe.defaultDatetimeFormat,frappe.defaultTimeFormat],!0).isValid()}}),Object.defineProperties(window,{dateutil:{get:function(){return console.warn("Please use `frappe.datetime` instead of `dateutil`. It will be deprecated soon."),frappe.datetime},configurable:!0},date:{get:function(){return console.warn("Please use `frappe.datetime` instead of `date`. It will be deprecated soon."),frappe.datetime},configurable:!0},get_today:{get:function(){return console.warn("Please use `frappe.datetime.get_today` instead of `get_today`. It will be deprecated soon."),frappe.datetime.get_today},configurable:!0}}),frappe.provide("frappe.ui"),frappe.provide("frappe.views"),frappe.provide("frappe.web_form_list");class e{constructor(e){Object.assign(this,e),frappe.web_form_list=this,this.wrapper=document.getElementById("datatable"),this.make_actions(),this.make_filters(),$(".link-btn").remove()}refresh(){var e=this;this.table&&(Array.from(this.table.tBodies).forEach(function(e){return e.remove()}),document.getElementById("select-all").checked=!1);this.rows=[],this.page_length=20,this.web_list_start=0,frappe.run_serially([function(){return e.get_list_view_fields()},function(){return e.get_data()},function(){return e.make_table()},function(){return e.create_more()}])}make_filters(){var e=this;this.filters={},this.filter_input=[];var t=document.getElementById("list-filters");frappe.call("frappe.website.doctype.web_form.web_form.get_web_form_filters",{web_form_name:this.web_form_name}).then(function(a){a.message.forEach(function(a){var r=document.createElement("div.col-sm-4");r.classList.add("col","col-sm-3"),t.appendChild(r),a.default&&e.add_filter(a.fieldname,a.default,a.fieldtype);var n=frappe.ui.form.make_control({df:{fieldtype:a.fieldtype,fieldname:a.fieldname,options:a.options,only_select:!0,label:__(a.label),onchange:function(t){$("#more").remove(),e.add_filter(a.fieldname,n.value,a.fieldtype),e.refresh()}},parent:r,value:a.default,render_input:1});e.filter_input.push(n)}),e.refresh()})}add_filter(e,t,a){t?("Data"===a&&(t=["like",t+"%"]),Object.assign(this.filters,Object.fromEntries([[e,t]]))):delete this.filters[e]}get_list_view_fields(){var e=this;return frappe.call({method:"frappe.website.doctype.web_form.web_form.get_in_list_view_fields",args:{doctype:this.doctype}}).then(function(t){return e.fields_list=t.message})}fetch_data(){return frappe.call({method:"frappe.www.list.get_list_data",args:Object.assign({},{doctype:this.doctype,fields:this.fields_list.map(function(e){return e.fieldname}),limit_start:this.web_list_start,web_form_name:this.web_form_name},this.filters)})}async get_data(){var e=await this.fetch_data();this.data=await e.message}more(){var e=this;this.web_list_start+=this.page_length,this.fetch_data().then(function(t){0===t.message.length&&frappe.msgprint(__("No more items to display")),e.append_rows(t.message)})}make_table(){this.columns=this.fields_list.map(function(e){return{label:e.label,fieldname:e.fieldname,fieldtype:e.fieldtype}}),this.table||(this.table=document.createElement("table"),this.table.classList.add("table"),this.make_table_head()),this.append_rows(this.data),this.wrapper.appendChild(this.table)}make_table_head(){var e=this,t=this.table.createTHead();t.style.backgroundColor="#f7fafc",t.style.color="#8d99a6";var a=t.insertRow(),r=document.createElement("th"),n=document.createElement("input");function o(e,t){var a=document.createElement("th");a.innerText=t,e.appendChild(a)}n.type="checkbox",n.id="select-all",n.onclick=function(t){return e.toggle_select_all(t.target.checked)},r.appendChild(n),a.appendChild(r),o(a,__("Sr")),this.columns.forEach(function(e){o(a,__(e.label))})}append_rows(e){var t=this,a=this.table.childNodes[1]||this.table.createTBody();e.forEach(function(e){var r=a.insertRow();r.setAttribute("id",e.name);var n=new frappe.ui.WebFormListRow({row:r,doc:e,columns:t.columns,serial_number:t.rows.length+1,events:{onEdit:function(){return t.open_form(e.name)},onSelect:function(){return t.toggle_delete()}}});t.rows.push(n)})}make_actions(){var e=this,t=document.querySelector(".list-view-actions");frappe.has_permission(this.doctype,"","delete",function(){e.addButton(t,"delete-rows","danger",!0,"Delete",function(){return e.delete_rows()})}),this.addButton(t,"new","primary",!1,"New",function(){return window.location.href=window.location.pathname+"?new=1"})}addButton(e,t,a,r,n,o){if(!document.getElementById(t)){var i=document.createElement("button");"secondary"==a?i.classList.add("btn","btn-secondary","btn-sm","ml-2","text-white"):"danger"==a?i.classList.add("btn","btn-danger","button-delete","btn-sm","ml-2"):i.classList.add("btn","btn-primary","btn-sm","ml-2"),i.id=t,i.innerText=n,i.hidden=r,i.onclick=o,e.appendChild(i)}}create_more(){var e=this;if(this.rows.length>=this.page_length){var t=document.querySelector(".list-view-footer");this.addButton(t,"more","secondary",!1,"More",function(){return e.more()})}}toggle_select_all(e){this.rows.forEach(function(t){return t.toggle_select(e)})}open_form(e){window.location.href=window.location.pathname+"?name="+e}get_selected(){return this.rows.filter(function(e){return e.is_selected()})}toggle_delete(){this.settings.allow_delete&&(document.getElementById("delete-rows").hidden=!this.get_selected().length)}delete_rows(){var e=this;this.settings.allow_delete&&frappe.call({type:"POST",method:"frappe.website.doctype.web_form.web_form.delete_multiple",args:{web_form_name:this.web_form_name,docnames:this.get_selected().map(function(e){return e.doc.name})}}).then(function(){e.refresh(),e.toggle_delete()})}}frappe.ui.WebFormListRow=class{constructor(e){var t=e.row,a=e.doc,r=e.columns,n=e.serial_number,o=e.events;e.options;Object.assign(this,{row:t,doc:a,columns:r,serial_number:n,events:o}),this.make_row()}make_row(){var e=this,t=this.row.insertCell();this.checkbox=document.createElement("input"),this.checkbox.type="checkbox",this.checkbox.onclick=function(t){e.toggle_select(t.target.checked),t.stopImmediatePropagation()},t.appendChild(this.checkbox),this.row.insertCell().innerText=this.serial_number,this.columns.forEach(function(t){var a=e.row.insertCell(),r=frappe.form.get_formatter(t.fieldtype);a.innerHTML=e.doc[t.fieldname]&&__(r(e.doc[t.fieldname],t,{only_value:1},e.doc))||""}),this.row.onclick=function(){return e.events.onEdit()},this.row.style.cursor="pointer"}toggle_select(e){this.checkbox.checked=e,this.events.onSelect(e)}is_selected(){return this.checkbox.checked}},frappe.provide("frappe.utils");var t={init:function(){this.jq=jQuery({})},trigger:function(e,t){!this.jq&&this.init(),this.jq.trigger(e,t)},once:function(e,t){!this.jq&&this.init(),this.jq.one(e,function(e,a){return t(a)})},on:function(e,t){!this.jq&&this.init(),this.jq.bind(e,function(e,a){return t(a)})},off:function(e,t){!this.jq&&this.init(),this.jq.unbind(e,function(e,a){return t(a)})}};frappe.utils.make_event_emitter=function(e){return Object.assign(e,t),e},frappe.provide("frappe.ui"),frappe.provide("frappe.web_form");class a extends frappe.ui.FieldGroup{constructor(e){super(),Object.assign(this,e),frappe.web_form=this,frappe.web_form.events={},Object.assign(frappe.web_form.events,t)}prepare(e,t){Object.assign(this,e),this.fields=e.web_form_fields,this.doc=t}make(){super.make(),this.set_field_values(),this.introduction_text&&this.set_form_description(this.introduction_text),this.allow_print&&!this.is_new&&this.setup_print_button(),this.allow_delete&&!this.is_new&&this.setup_delete_button(),this.is_new&&this.setup_cancel_button(),this.setup_primary_action(),$(".link-btn").remove(),frappe.init_client_script&&frappe.init_client_script(),frappe.web_form.events.trigger("after_load"),this.after_load&&this.after_load()}on(e,t){var a=this.fields_dict[e];a.df.change=function(){t(a,a.value)}}set_field_values(){this.doc.name&&this.set_values(this.doc)}set_default_values(){var e=frappe.utils.get_query_params();delete e.new,this.set_values(e)}set_form_description(e){document.getElementById("introduction").innerHTML=e}add_button(e,t,a,r){void 0===r&&(r=".web-form-actions");var n=document.createElement("button");n.classList.add("btn","btn-"+t,"btn-sm","ml-2"),n.innerHTML=e,n.onclick=a,document.querySelector(r).appendChild(n)}add_button_to_footer(e,t,a){this.add_button(e,t,a,".web-form-footer")}add_button_to_header(e,t,a){this.add_button(e,t,a,".web-form-actions")}setup_primary_action(){var e=this;this.add_button_to_header(this.button_label||"Save","primary",function(){return e.save()}),this.add_button_to_footer(this.button_label||"Save","primary",function(){return e.save()})}setup_cancel_button(){var e=this;this.add_button_to_header(__("Cancel"),"light",function(){return e.cancel()})}setup_delete_button(){var e=this;frappe.has_permission(this.doc_type,"","delete",function(){e.add_button_to_header(frappe.utils.icon("delete"),"danger",function(){return e.delete()})})}setup_print_button(){var e=this;this.add_button_to_header(frappe.utils.icon("print"),"light",function(){return e.print()})}save(){var e=this,t=this.is_new;this.validate&&!this.validate()&&frappe.throw(__("Couldn't save, please check the data you have entered"),__("Validation Error"));var a=super.get_values(this.allow_incomplete);if(a&&!window.saving){var r=Boolean(this.accept_payment&&!this.doc.paid);return Object.assign(this.doc,a),this.doc.doctype=this.doc_type,this.doc.web_form_name=this.name,window.saving=!0,frappe.form_dirty=!1,frappe.call({type:"POST",method:"frappe.website.doctype.web_form.web_form.accept",args:{data:this.doc,web_form:this.name,docname:this.doc.name,for_payment:r},callback:function(a){a.exc||(e.handle_success(a.message),frappe.web_form.events.trigger("after_save"),e.after_save&&e.after_save(),t&&(a.message.attachment||a.message.file)&&frappe.call({type:"POST",method:"frappe.handler.upload_file",args:{file_url:a.message.attachment||a.message.file,doctype:a.message.doctype,docname:a.message.name}}))},always:function(){window.saving=!1}}),!0}}delete(){frappe.call({type:"POST",method:"frappe.website.doctype.web_form.web_form.delete",args:{web_form_name:this.name,docname:this.doc.name}})}print(){window.open("/printview?\n\t\t\tdoctype="+this.doc_type+"\n\t\t\t&name="+this.doc.name+"\n\t\t\t&format="+(this.print_format||"Standard"),"_blank")}cancel(){window.location.href=window.location.pathname}handle_success(e){var t=this;this.accept_payment&&!this.doc.paid&&(window.location.href=e);var a=new frappe.ui.Dialog({title:__("Saved Successfully"),secondary_action:function(){t.success_url?window.location.href=t.success_url:t.login_required&&(window.location.href=window.location.pathname+"?name="+e.name)}});a.show();var r=this.success_message||__("Your information has been submitted");a.set_message(r)}}frappe.ready(function(){var t=frappe.utils.get_query_params(),r=$(".web-form-wrapper"),n=parseInt(r.data("is-list"))||t.is_list,o=r.data("web-form-doctype"),i=r.data("web-form"),s=parseInt(r.data("login-required")),d=parseInt(r.data("allow-delete")),f=t.name||"",m=t.new;s?function(){var e=new frappe.ui.Dialog({title:__("Not Permitted"),primary_action_label:__("Login"),primary_action:function(){window.location.replace("/login?redirect-to="+window.location.pathname)}});e.set_message(__("You are not permitted to access this page.")),e.show()}():n?new e({parent:r,doctype:o,web_form_name:i,settings:{allow_delete:d}}):function(){var e=new a({parent:r,is_new:m,web_form_name:i});frappe.call({method:"frappe.website.doctype.web_form.web_form.get_form_data",args:{doctype:o,docname:f,web_form_name:i},freeze:!0}).then(function(t){var a,r=((a=t.message).web_form.web_form_fields.map(function(e){if(e.is_web_form=!0,"Table"===e.fieldtype)return e.get_data=function(){var t=[];return a.doc&&(t=a.doc[e.fieldname]),t},e.fields=a[e.fieldname],$.each(e.fields||[],function(e,t){"Link"===t.fieldtype&&(t.only_select=!0),t.is_web_form=!0}),"Attach"===e.fieldtype&&(e.is_private=!0),delete e.parent,delete e.parentfield,delete e.parenttype,delete e.doctype,e;"Link"===e.fieldtype&&(e.only_select=!0),["Attach","Attach Image"].includes(e.fieldtype)&&("object"!=typeof e.options&&(e.options={}),e.options.disable_file_browser=!0)}),a),n=r.web_form;n.name&&0===n.allow_edit&&(window.location.href.includes("?new=1")||window.location.replace(window.location.pathname+"?new=1"));t.message.doc||function(e){var t={};e.web_form.web_form_fields.forEach(function(e){if(e.default)return t[e.fieldname]=e.default})}(t.message);e.prepare(n,t.message.doc&&1===n.allow_edit?t.message.doc:{}),e.make(),e.set_default_values()})}(),document.querySelector("body").style.display="block"})}();
//# sourceMappingURL=web_form.min.js.map
