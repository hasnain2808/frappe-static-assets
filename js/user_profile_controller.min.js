!function(){"use strict";class e{constructor(e){Object.assign(this,e),this.make()}make(){this.timeline_wrapper=$('<div class="new-timeline">'),this.wrapper=this.timeline_wrapper,this.timeline_items_wrapper=$('<div class="timeline-items">'),this.timeline_actions_wrapper=$('\n\t\t\t<div class="timeline-actions">\n\t\t\t\t<div class="timeline-dot"></div>\n\t\t\t</div>\n\t\t'),this.timeline_wrapper.append(this.timeline_actions_wrapper),this.timeline_actions_wrapper.hide(),this.timeline_wrapper.append(this.timeline_items_wrapper),this.parent.replaceWith(this.timeline_wrapper),this.timeline_items=[]}refresh(){this.render_timeline_items()}add_action_button(e,t,i,r){void 0===i&&(i=null),void 0===r&&(r=null);var a=i?frappe.utils.icon(i,"xs"):null;this.timeline_actions_wrapper.show();var n=$('<button class="btn btn-xs '+(r||"btn-default")+' action-btn">\n\t\t\t'+a+"\n\t\t\t"+e+"\n\t\t</button>");return n.click(t),this.timeline_actions_wrapper.append(n),n}render_timeline_items(){var e=this;this.timeline_items_wrapper.empty(),this.timeline_items=[],this.doc_info=this.frm&&this.frm.get_docinfo()||{};var t=this.prepare_timeline_contents();t instanceof Promise?t.then(function(){e.timeline_items.sort(function(e,t){return new Date(t.creation)-new Date(e.creation)}),e.timeline_items.forEach(e.add_timeline_item.bind(e))}):(this.timeline_items.sort(function(e,t){return new Date(t.creation)-new Date(e.creation)}),this.timeline_items.forEach(this.add_timeline_item.bind(this)))}prepare_timeline_contents(){}add_timeline_item(e,t){void 0===t&&(t=!1);var i=this.get_timeline_item(e);return t?this.timeline_items_wrapper.append(i):this.timeline_items_wrapper.prepend(i),i}add_timeline_items(e,t){var i=this;void 0===t&&(t=!1),e.forEach(function(e){return i.add_timeline_item(e,t)})}get_timeline_item(e){var t=$('<div class="timeline-item">');return t.attr({"data-doctype":e.doctype,"data-name":e.name}),e.icon?t.append('\n\t\t\t\t<div class="timeline-badge" title=\''+(e.title||frappe.utils.to_title_case(e.icon))+"'>\n\t\t\t\t\t"+frappe.utils.icon(e.icon,e.icon_size||"md")+"\n\t\t\t\t</div>\n\t\t\t"):e.timeline_badge?t.append(e.timeline_badge):t.append('<div class="timeline-dot">'),t.append('<div class="timeline-content '+(e.is_card?"frappe-card":"")+'">'),t.find(".timeline-content").append(e.content),e.hide_timestamp||e.is_card||t.find(".timeline-content").append("<span> - "+comment_when(e.creation)+"</span>"),t}}frappe.provide("frappe.energy_points");class t extends e{make(){super.make(),this.activity_start=0,this.activity_limit=20,this.setup_show_more_activity()}prepare_timeline_contents(){var e=this;return this.get_user_activity_data().then(function(t){if(!t.length)return e.show_more_button.hide(),void e.timeline_wrapper.html("<div>"+__("No activities to show")+"</div>");e.show_more_button.toggle(t.length===e.activity_limit),e.timeline_items=t.map(function(t){return e.get_activity_timeline_item(t)})})}get_user_activity_data(){return frappe.xcall("frappe.desk.page.user_profile.user_profile.get_energy_points_list",{start:this.activity_start,limit:this.activity_limit,user:this.user})}get_activity_timeline_item(e){return{icon:"Appreciation"==e.type?"clap":"Criticism"==e.type?"criticize":null,creation:e.creation,is_card:!0,content:frappe.energy_points.format_history_log(e)}}setup_show_more_activity(){var e=this;this.show_more_button=$('<a class="show-more-activity-btn">'+__("Show More Activity")+"</a>"),this.show_more_button.hide(),this.footer.append(this.show_more_button),this.show_more_button.on("click",function(){return e.show_more_activity()})}show_more_activity(){var e=this;this.activity_start+=this.activity_limit,this.get_user_activity_data().then(function(t){(!t.length||t.length<e.activity_limit)&&e.show_more_button.hide(),t.map(function(t){return e.get_activity_timeline_item(t)}).map(function(t){return e.add_timeline_item(t,!0)})})}}frappe.provide("frappe.ui"),frappe.ui.UserProfile=class{constructor(e){var t=this;this.wrapper=$(e),this.page=frappe.ui.make_app_page({parent:e}),this.sidebar=this.wrapper.find(".layout-side-section"),this.main_section=this.wrapper.find(".layout-main-section"),this.wrapper.bind("show",function(){t.show()})}show(){var e=this,t=frappe.get_route();this.user_id=t[1]||frappe.session.user,frappe.dom.freeze(__("Loading user profile")+"..."),frappe.db.exists("User",this.user_id).then(function(t){frappe.dom.unfreeze(),t?e.make_user_profile():frappe.msgprint(__("User does not exist"))})}make_user_profile(){this.user=frappe.user_info(this.user_id),this.page.set_title(this.user.fullname),this.setup_user_search(),this.main_section.empty().append(frappe.render_template("user_profile")),this.energy_points=0,this.review_points=0,this.rank=0,this.month_rank=0,this.render_user_details(),this.render_points_and_rank(),this.render_heatmap(),this.render_line_chart(),this.render_percentage_chart("type","Type Distribution"),this.create_percentage_chart_filters(),this.setup_user_activity_timeline()}setup_user_search(){var e=this;this.$user_search_button=this.page.set_secondary_action(__("Change User"),function(){return e.show_user_search_dialog()},{icon:"change",size:"sm"})}show_user_search_dialog(){var e=new frappe.ui.Dialog({title:__("Change User"),fields:[{fieldtype:"Link",fieldname:"user",options:"User",label:__("User")}],primary_action_label:__("Go"),primary_action:function(t){var i=t.user;e.hide(),frappe.set_route("user-profile",i)}});e.show()}render_heatmap(){this.heatmap=new frappe.Chart(".performance-heatmap",{type:"heatmap",countLabel:"Energy Points",data:{},discreteDomains:1,radius:3,height:150}),this.update_heatmap_data(),this.create_heatmap_chart_filters()}update_heatmap_data(e){var t=this;frappe.xcall("frappe.desk.page.user_profile.user_profile.get_energy_points_heatmap_data",{user:this.user_id,date:e||frappe.datetime.year_start()}).then(function(e){t.heatmap.update({dataPoints:e})})}render_line_chart(){this.line_chart_filters=[["Energy Point Log","user","=",this.user_id,!1],["Energy Point Log","type","!=","Review",!1]],this.line_chart_config={timespan:"Last Month",time_interval:"Daily",type:"Line",value_based_on:"points",chart_type:"Sum",document_type:"Energy Point Log",name:"Energy Points",width:"half",based_on:"creation"},this.line_chart=new frappe.Chart(".performance-line-chart",{type:"line",height:200,data:{labels:[],datasets:[{}]},colors:["purple"],axisOptions:{xIsSeries:1}}),this.update_line_chart_data(),this.create_line_chart_filters()}update_line_chart_data(){var e=this;this.line_chart_config.filters_json=JSON.stringify(this.line_chart_filters),frappe.xcall("frappe.desk.doctype.dashboard_chart.dashboard_chart.get",{chart:this.line_chart_config,no_cache:1}).then(function(t){e.line_chart.update(t)})}render_percentage_chart(e,t){var i=this;frappe.xcall("frappe.desk.page.user_profile.user_profile.get_energy_points_percentage_chart_data",{user:this.user_id,field:e}).then(function(e){e.labels.length?i.percentage_chart=new frappe.Chart(".performance-percentage-chart",{type:"percentage",data:{labels:e.labels,datasets:e.datasets},truncateLegends:1,barOptions:{height:11,depth:1},height:200,maxSlices:8,colors:["purple","blue","cyan","teal","pink","red","orange","yellow"]}):i.wrapper.find(".percentage-chart-container").hide()})}create_line_chart_filters(){var e=this,t=[{label:"All",options:["All","Auto","Criticism","Appreciation","Revert"],action:function(t){"All"===t?e.line_chart_filters=[["Energy Point Log","user","=",e.user_id,!1],["Energy Point Log","type","!=","Review",!1]]:e.line_chart_filters[1]=["Energy Point Log","type","=",t,!1],e.update_line_chart_data()}},{label:"Last Month",options:["Last Week","Last Month","Last Quarter","Last Year"],action:function(t){e.line_chart_config.timespan=t,e.update_line_chart_data()}},{label:"Daily",options:["Daily","Weekly","Monthly"],action:function(t){e.line_chart_config.time_interval=t,e.update_line_chart_data()}}];frappe.dashboard_utils.render_chart_filters(t,"chart-filter",".line-chart-options",1)}create_percentage_chart_filters(){var e=this,t=[{label:"Type",options:["Type","Reference Doctype","Rule"],fieldnames:["type","reference_doctype","rule"],action:function(t,i){var r=t+" Distribution";e.render_percentage_chart(i,r)}}];frappe.dashboard_utils.render_chart_filters(t,"chart-filter",".percentage-chart-options")}create_heatmap_chart_filters(){var e=this,t=[{label:frappe.dashboard_utils.get_year(frappe.datetime.now_date()),options:frappe.dashboard_utils.get_years_since_creation(frappe.boot.user.creation),action:function(t){e.update_heatmap_data(frappe.datetime.obj_to_str(t))}}];frappe.dashboard_utils.render_chart_filters(t,"chart-filter",".heatmap-options")}edit_profile(){var e=this,t=new frappe.ui.Dialog({title:__("Edit Profile"),fields:[{fieldtype:"Attach Image",fieldname:"user_image",label:"Profile Image"},{fieldtype:"Data",fieldname:"interest",label:"Interests"},{fieldtype:"Column Break"},{fieldtype:"Data",fieldname:"location",label:"Location"},{fieldtype:"Section Break",fieldname:"Interest"},{fieldtype:"Small Text",fieldname:"bio",label:"Bio"}],primary_action:function(i){t.disable_primary_action(),frappe.xcall("frappe.desk.page.user_profile.user_profile.update_profile_info",{profile_info:i}).then(function(r){r.image=r.user_image,e.user=Object.assign(i,r),t.hide(),e.render_user_details()}).finally(function(){t.enable_primary_action()})},primary_action_label:__("Save")});t.set_values({user_image:this.user.image,location:this.user.location,interest:this.user.interest,bio:this.user.bio}),t.show()}render_user_details(){this.sidebar.empty().append(frappe.render_template("user_profile_sidebar",{user_image:this.user.image,user_abbr:this.user.abbr,user_location:this.user.location,user_interest:this.user.interest,user_bio:this.user.bio})),this.setup_user_profile_links()}setup_user_profile_links(){var e=this;this.user_id!==frappe.session.user?this.wrapper.find(".profile-links").hide():(this.wrapper.find(".edit-profile-link").on("click",function(){e.edit_profile()}),this.wrapper.find(".user-settings-link").on("click",function(){e.go_to_user_settings()}))}get_user_rank(){var e=this;return frappe.xcall("frappe.desk.page.user_profile.user_profile.get_user_rank",{user:this.user_id}).then(function(t){t.monthly_rank.length&&(e.month_rank=t.monthly_rank[0]),t.all_time_rank.length&&(e.rank=t.all_time_rank[0])})}get_user_points(){var e=this;return frappe.xcall("frappe.social.doctype.energy_point_log.energy_point_log.get_user_energy_and_review_points",{user:this.user_id}).then(function(t){t[e.user_id]&&(e.energy_points=t[e.user_id].energy_points,e.review_points=t[e.user_id].review_points)})}render_points_and_rank(){var e=this,t=this.wrapper.find(".user-stats"),i=this.wrapper.find(".user-stats-detail"),r=function(e,t,i){return'<div class="user-stats-item mt-4">\n\t\t\t\t'+frappe.utils.icon(i,"lg","no-stroke")+'\n\t\t\t\t<div>\n\t\t\t\t\t<div class="stat-value">'+e+'</div>\n\t\t\t\t\t<div class="stat-label">'+t+"</div>\n\t\t\t\t</div>\n\t\t\t</div>"};this.get_user_rank().then(function(){e.get_user_points().then(function(){var a=$("\n\t\t\t\t\t"+r(e.energy_points,__("Energy Points"),"color-energy-points")+"\n\t\t\t\t\t"+r(e.review_points,__("Review Points"),"color-review-points")+"\n\t\t\t\t\t"+r(e.rank,__("Rank"),"color-rank")+"\n\t\t\t\t\t"+r(e.month_rank,__("Monthly Rank"),"color-monthly-rank")+"\n\t\t\t\t");t.append(a),i.removeClass("hide")})})}go_to_user_settings(){frappe.set_route("Form","User",this.user_id)}setup_user_activity_timeline(){this.user_activity_timeline=new t({parent:this.wrapper.find(".recent-activity-list"),footer:this.wrapper.find(".recent-activity-footer"),user:this.user_id}),this.user_activity_timeline.refresh()}}}();
//# sourceMappingURL=user_profile_controller.min.js.map
